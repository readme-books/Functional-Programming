# chapter 7 : 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

- 바꿀 수 없는 라이브러리나 레거시 코드가 데이터를 변경하면 카피-온-라이트는 적용할 수 없다.

## 레거시 코드와 불변성

- 레거시 코드) 오래전에 만든 코드라는 뜻으로 지금 당장 고칠수 없어서 그대로 사용해야하는 코드
- 카피-온-라이트 원칙을 지키면서 안전하게 함수를 사용할 수 있는 "방어적 복사" 원칙이 존재함

## 방어적 복사

- 들어오고 나가는 뎅터의 복사본을 만드는것
- 안정지대에 불변성을 유지하고 바뀔수 있는 데이터가 안전지대로 들어오지 못하도록 하는것이 방어적 복자의 목적

### 방어적 복사 규칙

1. 데이터가안전한 코드에서 나갈때 복사하기

- 불변성 데이터를 위한 깊은 복사본을 만들고 신뢰할 수 없는 코드로 복사본을 전달

2. 안전한 코드로 데이터가 들어올때 복사하기

- 변경될수도 있는 데이터가 들어올때 깊은 복사본을 만들어 안전한 코드로 전달하고 복사본을 안전한 코드에서 사용한다.

-> 순서에 관계없이 사용가능
-> 공유라이브러리나 신뢰할 수 없는 라이브러리 함수를 사용할 경우

[연습문제]

```jsx
//[원래 코드]
function payrollcalc(employees) {
  //
  return payrollchecks;
}

//[방어적 복사로 만들기]
function payrollcalcSafe(empolyees) {
  var copy = deepCopy(empolyees);
  var payrollCheck = payrollcalc(copy);
  return deepCopy(payrollCheck);
}
```

## 방어적 복사의 일반적인 사례

### 웹 api 속 방어적 복사

- JSON 데이터가 api 에 요정으로 들어올때 클라이언트는 데이터를 인터넷을 통해 api로 보내려고 직렬화 함. -> 이때 JSON 데이터는 깊은복사본이다.
- 서비스에 들어올때와 나갈때 데이터를 복사한것.
- 웹 API는 마이크로서비스나 서비스지향 시스템이 서로 통신할때 암묵적으로 방어적 복사를 한다.

### 얼랭과 엘릭서에서 방어적 복사

- 얼랭에서 두 프로세스가 서로 메세지를 주고받을때 수신자의 메일박스에 메세지가 복사된다.
- 프로세스에서 데이터가 나갈때도 데이터를 복사한다.

## 카피-온-라이트 와 방어적 복사의 차이점

- **방어적 복사**는 깊은복사
  - 위에서 아래로 모든 계층의 중첩된 데이터 복사, 얕은 복사보다 더 많은 비용이 든다.
  - 안전지대의 경계에서 데이터가 오고갈때 방어적 복사를 사용 (신뢰할 수 없는 코드와 데이터를 주고받아야할때)
- 카피-온-라이트는 얕은복사
  - 안전지대에서는 데이터를 전달할때 많은 복사가 불필요함.
  - 연산과 메모리 낭비를막기위해 가능한 안전지대에서는 카피-온-라이트 원칙을 사용하는편이 좋음
  - 안전지대 어디서나 사용가능(통제할 수 있는 데이터를 바꿀때 사용) -> 불변성을 가진 안전지대를 만듦

Q. 카피온라이트는 다른 카피온라이트 함수를 호출할때만 쓸수있다.??
