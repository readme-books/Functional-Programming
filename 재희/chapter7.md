### \# chapter 7

## \' 신뢰할 수 없는 코드를 사용하며 불변성 지키기 \'

- 바꿀 수 없는 라이브러리나 레거시 코드가 데이터를 변경할 경우 -> copy-on-write 적용 불가
- 데이터를 변경하는 코드를 사용하면서 불변성을 지키기 위해 `방어적 복사` 사용
- `얕은 복사`와 `깊은 복사` 비교<br><br>


<hr>


### 방어적 복사란
신뢰할 수 없는 코드가 계속 데이터 참조를 가지고 있어 언제든 바뀌기 때문에 copy-on-write 패턴으로 해결 불가<br>
원본 데이터가 바뀌는 것을 막아주는 원칙 -> `방어적 복사` <br>

불변성이 지켜지는 `안전지대`<br>
안전지대에 들어오는 데이터를 깊은 복사하면 복사본은 데이터가 바뀌어도 영향을 받지 않음<br>
안전지대에 있는 데이터가 밖으로 나가는 경우에도 신뢰할 수 없는 코드가 원본 데이터를 변경하지 못하도록 깊은 복사 후 복사본을 내보냄<br>

- 데이터가 안전한 코드에서 나갈 때 깊은 복사
- 안전한 코드로 데이터가 들어올 때 깊은 복사
<br>

규칙은 순서 상관없이 적용 가능<br>
신뢰할 수 없는 라이브러리를 사용하는 경우 먼저 데이터가 나가고 나중에 들어올 수도 있음, 반대도 가능<br>
어떤 경우에는 들어오는 데이터가 없거나 나가는 데이터가 없을 수도 있음<br>

#### 방어적 복사 코드를 분리해 새로운 함수로 만들어 신뢰할 수 없는 코드를 감싸는 방식 추천<br><br><br>



### 방어적 복사가 사용된 예시
- `웹 API`<br>
JSON 데이터가 API에 요청으로 들어오면 클라이언트는 데이터를 인터넷을 통해 API로 보내기 위해 직렬화함 -> 이 때 JSON 데이터가 깊은 복사본<br>
서비스가 잘 동작하면 JSON으로 응답 -> 이 응답 역시 깊은 복사본<br>
- 함수형 프로그래밍 언어 `얼랭(Erlang)` & `엘릭서(Elixir)`<br>
얼랭에서 두 프로세스가 서로 메시지를 주고 받을 때 메일박스에 메시지가 복사됨<br>
프로세스에서 데이터가 나갈 때에도 데이터를 복사함<br>
방어적 복사는 얼랭 시스템이 고가용성을 보장하는 **핵심 기능**<br><br><br>


### copy-on-write와 방어적 복사
- 둘 다 불변성을 유지하기 위해 사용
- copy-on-write는 `얕은 복사`를 방어적 복사는 `깊은 복사`를 사용
- 안전지대에서는 깊은 복사를 사용하며 연산과 메모리를 낭비할 필요가 없기 때문에 copy-on-write를 사용해야 함


|  | copy-on-write | 방어적 복사 |
| :--: | :--: | :--: |
| 사용 시점 | 통제할 수 있는<br> 데이터를 변경할 때 | 신뢰할 수 없는 코드와<br> 데이터를 주고받아야 할 때 |
| 사용하는 곳 | 사용함으로써 불변성을 가진<br> 안전지대를 만듦 | 안전지대의 경계에서<br> 데이터가 오고 갈 때 |
| 복사 방식 | 얕은 복사 | 깊은 복사 |
| 규칙 | 바꿀 데이터를 얕은 복사<br> -> 복사본 변경<br> -> 복사본 리턴 | 안전지대로 들어오는 데이터에<br> 깊은 복사본 생성<br> -> 안전지대에서 나가는 데이터에<br> 깊은 복사 생성 |

<br>

### 얕은 복사와 깊은 복사
깊은 복사는 원본과 어떤 데이터 구조도 공유하지 않음<br>
중첩된 모든 객체나 배열을 복사함<br>
얕은 복사는 바뀌지 않은 값을 원본과 복사본이 데이터 공유함<br><br><br>


### 자바스크립트에서 깊은 복사 구현 시
자바스크립트의 표준 라이브러리가 좋지 않아 직접 구현하기 어려움<br>
Lodash 라이브러리의 .cloneDeep() 함수를 사용하여 깊은 복사 추천<br><br><br>


<hr>

` 🔍 용어 정리 `
- `레거시 코드(legacy code)` : 오래전에 만든 것, 당장 고칠 수 없어 그대로 사용해야 하는 코드
- `깊은 복사(deep copy)` : 위에서 아래로 모든 계층에 있는 중첩된 데이터 구조를 복사하는 것
- `비공유 아키텍처(share nothing architecture)` : 모듈이 서로 통신하기 위해 방어적 복사를 구현

<hr>
