### \# chapter 15

## \' 타임라인 격리하기 \'

- 코드를 타임라인 다이어그램으로 그리는 방법
- 버그를 찾기 위해 타임라인 다이어그램 보는 방법
- 타임라인끼리 공유하는 자원을 줄여 코드 설계를 개선하는 방법<br><br>


<hr>


## 타임라인 다이어그램 timeline diagram
- 타임라인 : 동시에 실행될 수 있는 순차적 액션
- 시간에 따른 액션 순서를 시각적으로 표시한 것
- 코드가 순서대로 실행되는지 동시에 실행되는지 알 수 있음
- 계산은 실행 시점에 영향을 받지 않기 때문에 그리지 않음
- 코드가 순서대로 실행되는지 동시에 실행되는지 알 수 있음 -> 서로 영향을 주는 부분이 어떤 부분인지 알 수 있음

### 기본 규칙
1. 두 액션이 순서대로 나타나면 같은 타임라인에 넣기
2. 두 액션이 동시에 실행되거나 순서를 예상할 수 없다면 분리된 타임라인에 넣기
3. 비동기 콜백은 새로운 타임라인에 넣기


### 액션 순서에 관한 알아야 할 2가지
1. ++와 +=는 3단계<br>

`total++`을 풀어 쓰면
```js
var temp = total; // 읽기(액션)
temp = temp + 1;  // 더하기(계산)
total = temp;     // 쓰기(액션)
```


2. 인자는 함수를 부르기 전에 실행됨

`console.log(total);`은
```js
var temp = total;  // 읽기(액션)
console.log(temp); // 로깅(액션)
```

<br>

### 순서대로 실행되는 코드의 두 가지 종류
- 일반적으로 순서대로 실행되는 두 액션 사이에 다른 타임라인에 있는 액션이 끼어 들 수 있음
1. 순서가 섞일 수 있는 코드 : 두 액션 사이에 시간이 얼마나 걸릴지 알 수 없음
2. 순서가 섞이지 않는 코드 : 두 액션이 차례대로 실행되는데 다른 작업이 끼어 들지 못함 (다이어그램 그릴 때 박스 하나로 표기)

<br>

## 좋은 타임라인의 원칙
1. 타임라인은 적을수록 이해하기 쉬움
    - 타임라인이 하나라면 모든 액션은 앞의 액션 다음에 실행됨
    - 멀티스레드나 비동기 콜백, 클라이언트-서버 간 통신을 사용하려면 새로운 타임라인이 필요
2. 타임라인은 짧을수록 이해하기 쉬움
    - 타임라인의 단계를 줄이면 실행 가능한 순서의 수도 많이 줄일 수 있음
3. 공유하는 자원이 적을수록 이해하기 쉬움
    - 서로 다른 타임라인에 있는 액션이 자원을 공유하지 않는다면 실행 순서가 상관 없어짐
    - 실행 가능한 순서의 개수가 줄어들지 않지만, 신경 써야할 실행 가능한 순서를 줄일 수 있음
4. 자원을 공유한다면 서로 조율해야 함
    - 공유 자원을 안전하게 공유(올바른 순서대로 자원을 쓰고 돌려줌)할 수 있어야 함
    - 타임라인 간 조율은 올바른 결과를 주지 않는 실행 순서를 없애는 것
5. 시간을 일급으로 다룸
    - 액션의 순서와 타이밍을 맞추는 것은 어렵지만 타임라인을 다루는 재사용 가능한 객체를 만들면 타이밍을 맞추기 쉬워짐


<br>

## 자바스크립트의 특징

### 단일 스레드, 비동기 모델
- 자바스크립트는 스레드가 하나이기 때문에 입출력 작업을 하려면 비동기 모델을 사용해야 함
- 입출력의 결과는 콜백으로 받을 수 있지만 언제 끝날지 알 수 없어 다른 타임라인에 표기해야 함
- 자바스크립트는 일반적으로 위에서 아래로 코드가 실행되므로 위에서부터 타임라인 작성하기

### 단일 스레드
- 자바스크립트는 하나의 메인스레드만 존재 -> 대부분의 액션을 하나의 뱍스로 표현 -> 두 액션이 동시에 실행될 일 X
- 전역변수를 바꾸는 동기 액션은 타임라인이 서로 섞이지 않음
- 두 동기 액션은 동시에 실행되지 않음
- 절차적 프로그래밍으로 공유변수를 읽고 쓸 때 타임라인에 대해 고민할 필요 X
- 하지만 비동기 콜백을 사용한다면 문제가 생길 수 있음
- 비동기 호출은 미래에 알 수 없는 시점에 런타임에 의해 실행됨

### 비동기 큐
- 작업 큐 : 브라우저에서 동작하는 자바스크립트 엔진이 가지고 있는 큐
    - 예측 불가능한 시점에 이벤트가 발생하면 큐에 작업이 추가 됨(이벤트ex. 마우스 클릭, 키보드 입력, AJAX 이벤트)
    - 작업 큐 내의 `작업` : `이벤트 데이터` + `이벤트를 처리할 콜백`으로 구성
    - 이벤트 루프는 이벤트 데이터를 인자로 콜백을 호출
    - 콜백은 이벤트 루프가 실행할 함수
    - 이벤트 루프는 첫번째 인자에 이벤트 데이터를 넣어 콜백 함수를 실행
- 작업 큐는 이벤트 루프에 의해 처리됨
- 이벤트 루프는 큐에서 작업 하나를 꺼내 실행하고 완료되면 다음 작업을 꺼내 실행하는 것을 무한히 반복함
- 이벤트 루프는 하나의 스레드에서 처리하기 때문에 두 개의 작업이 동시에 실행될 수 없음

### AJAX와 이벤트 큐
- AJAX(Asynchronous JavaScript And XML) : 브라우저에 기반을 둔 웹 요청
- 브라우저에서 서버와 통신할 때 사용
- 비동기로 실행 됨
- 자바스크립트에서 AJAX 요청을 만들면 네트워크 엔진이 AJAX 요청을 처리하기 위해 요청 큐에 넣음
- 네트워크 엔진 : 연결을 맺고 캐싱을 하고 AJAX 이벤트를 작업 큐에 넣는 일 수행
- 비동기이기 때문에 요청이 완료될 때까지 기다리지 않고 코드는 계속 실행 됨
- AJAX 콜백도 요청 순서와 상관없이 작업 큐에 들어감

### 비동기 호출에서 명시적 출력을 위해 리턴값 대신 콜백을 사용할 수 있다
- 비동기 호출은 결과값을 리턴값으로 줄 수 없음
- 비동기 호출은 바로 리턴이 되지만 결과값은 콜백이 호출되어야 얻을 수 있기 때문
- 동기화된 함수와 같이 일반적인 방법으로 결과를 받을 수 없음
- 비동기 호출에서 결과를 받을 수 있는 방법 => 콜백을 사용하는 방법
- 결과가 준비되었을 때 결과를 인자로 넣어 콜백을 호출
- 자바스크립트의 일반적인 프로그래밍 방법
- 함수형 프로그래밍을 할 때 비동기 함수에서 액션을 빼낼 때 위와 같은 방법을 사용할 수 있음
- 동기화된 함수에서 액션을 빼낼 때 액션을 호출하는 대신 액션에 넘기는 인잣값을 리턴
- 호출하는 곳에서 리턴값을 받아 액션을 호출
- 비동기 함수에서는 리턴값 대신 콜백을 사용

<br>

## 타임라인 다이어그램 그리기

### 다이어그램을 그리기 위한 세 단계
1. 액션을 확인
2. 각 액션을 그리기
    - 순서대로 실행되는 액션 : 하나가 끝나고 다음이 시작
        - 같은 타임라인에 표시
    - 동시에 실행되는 액션 : 동시에 실행되거나 왼쪽 먼저 또는 오른쪽 먼저 실행
        - 동시에 실행되거나 순서가 섞여서 실행되는 경우 분리된 타임라인으로 표시
        - 비동기 콜백 / 멀티 프로세스 / 멀티스레드 / 여러 장치 등의 경우 액션이 동시 실행될 수 있음
    - 실행 순서를 점선을 사용하여 표현
3. 단순화하기
    - 순서가 섞이지 않는 두 액션은 하나의 박스로 합치기
    - 타임라인 끝에서 새로운 타임라인이 하나만 생긴다면 하나로 합치기
    - 순서에 제약이 있는 경우 점선을 추가

### 자바스크립트에서 타임라인 단순화하기 위한 두 단계
1. 액션을 통합
2. 타임라인을 통합

### 타임라인을 쉽게 만드는 네 가지 원칙
1. 적은 타임라인
2. 짧은 타임라인
3. 적은 공유 자원
4. 자원을 공유한다면 조율


<br>
<hr>

` 🔍 용어 정리 `
- `타임라인 다이어그램(timeline diagram)` : 시간에 따른 액션 순서를 시각적으로 표시한 것
<hr>
<br>